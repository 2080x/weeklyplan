# 工作周计划登记系统（MVP）

一个轻量的「周计划登记 + 工时汇总 + 导出 Excel + 邮件发送 + 部门视图」系统。

技术栈：FastAPI + SQLAlchemy + SQLite（默认）+ Jinja2（页面）+ openpyxl（Excel 导出）。

---

## 功能概览

### 普通用户

- 登录/退出
- 我的周计划（按月查看各周卡片）
  - 进入周计划登记（弹窗内打开）
  - 发送邮件（含 Excel 附件，需先配置邮箱）
- 周计划详情（登记页）
  - 条目 Excel 风格表格展示
  - 行级「修改/保存」切换（默认只读）
  - 新增条目、删除条目、复制上周计划
  - 导出 Excel（与表头一致，含合计行）
  - 提交（将周计划状态从 draft 提交为 submitted）
- 邮箱配置（每个账号单独配置 SMTP + 自动发送）

### 管理员

- 部门视图（按周）
  - 每个部门一张卡片，展示本周登记情况与工时汇总
  - 查看部门详情清单（该部门所有人员的本周周计划清单）
- 字典管理：所属大类/子项目维护
- 用户管理：创建用户、设置角色、绑定部门
- 节假日设置：维护休息日/补班日（影响“工作日”计算）
- 操作日志：查看关键操作记录

---

## 环境要求

- Python 3.9+

---

## 安装与运行

```bash
cd weekly-plan-system
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
export $(cat .env.example | xargs)  # 可选：按需覆盖环境变量
uvicorn app.main:app --reload --port 8000
```

浏览器打开：`http://127.0.0.1:8000`

---

## 默认账号

首次启动会自动初始化一个管理员账号（可用环境变量覆盖）：

- 用户名：`admin`
- 密码：`admin123`

相关环境变量：

- `INIT_ADMIN_USERNAME`
- `INIT_ADMIN_PASSWORD`
- `INIT_ADMIN_NAME`

---

## 数据与配置

### 数据库

默认使用 SQLite（本地文件）：

- `data/app.db`

可通过 `DATABASE_URL` 切换到 PostgreSQL/MySQL（SQLAlchemy URL），例如：

```bash
export DATABASE_URL="postgresql+psycopg2://user:pass@127.0.0.1:5432/weekly_plan"
```

### 节假日 / 补班日（影响“工作日”显示）

系统会按 ISO 周期计算工作日范围，并根据以下来源修正：

- 文件：`data/calendar.json`（优先）
- 环境变量：`HOLIDAYS`、`WORKDAYS`（逗号分隔的 ISO 日期）
- 环境变量文件：`HOLIDAYS_FILE`、`WORKDAYS_FILE`（每行一个 ISO 日期，支持 `#` 注释）

管理员也可以在页面「节假日设置」里直接维护。

### 邮箱配置（每个账号独立）

每个账号的邮箱配置会保存到：

- `data/email_config_users/<user_id>.json`

配置项包括：SMTP 主机/端口/账号密码、From、默认 To、STARTTLS/SSL、以及定时自动发送（每周一次）。

---

## 使用说明

### 1) 登录

访问 `http://127.0.0.1:8000` 会跳转到登录页，登录后进入「我的周计划」。

### 2) 我的周计划

入口：左侧菜单「我的周计划」

- 顶部可直接进入「本周登记」，旁边日期控件可切换“本周”指向的周
- “本月周计划”区域按周展示卡片
  - 点「登记」进入该周周计划详情（弹窗内）
  - 已登记（条目数 > 0）时可点「发送邮件」

### 3) 周计划详情（登记页）

入口：在「我的周计划」点击「登记」进入

- 表格默认只读展示（Excel 风格）
- 每行点击「修改」进入编辑态，再点一次变为「保存」并提交该行修改
- 支持「新增条目」「删除」「复制上周计划」
- 「导出Excel」：生成 `.xlsx` 文件（表头与页面一致，含合计行）
- 「提交」：仅在 `draft` 状态显示；提交后状态变为 `submitted`（用于自动发送筛选）

### 4) 邮箱配置

入口：左侧菜单「邮箱配置」

- 配置 SMTP 信息后，可在「我的周计划」中手动发送邮件（含 Excel 附件）
- 若开启“定时自动发送”，系统后台会在指定时间（每周一次）自动发送“本周已提交（submitted）”的周计划
  - 自动发送会按用户维度去重（每周只发一次）

### 5) 部门视图（管理员）

入口：左侧菜单「部门视图」

- 页面顶部支持日历选择 + 上周/本周/下周切换
- 每个部门一张卡片展示：
  - 成员数
  - 已登记人数/总人数
  - 预计/实际工时汇总
  - 最近更新时间
- 点击「详情」进入部门人员清单页
  - 列出该部门所有人员的本周周计划状态、更新时间、工时与事项数
  - 点击「查看」可在弹窗内打开该人员周计划详情

### 6) 字典管理（管理员）

入口：左侧菜单「字典管理」

- 维护「所属大类」「子项目」候选项，供登记页选择/自动补全使用

### 7) 用户管理（管理员）

入口：左侧菜单「用户管理」

- 创建用户、重置密码
- 设置角色（user/admin）
- 为用户绑定部门（用于部门视图统计）

### 8) 操作日志（管理员）

入口：左侧菜单「操作日志」

- 记录登录/登出、周计划提交/导出、邮件发送、字典与用户修改等关键操作

---

## 常见问题

### 1) 发送邮件提示“邮件配置不完整”

先到「邮箱配置」填写 `host/sender/to` 等必填项，再回到周卡片点击「发送邮件」。

### 2) 节假日同步按钮不可用/失败

节假日同步需要联网；如果运行环境禁网，请在「节假日设置」里手动维护休息日/补班日。
