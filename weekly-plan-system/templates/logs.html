{% extends "base.html" %}
{% block content %}
  <h1>操作日志（管理员）</h1>

  <div class="card">
    <h2>筛选</h2>
    <form method="get" action="/admin/logs" class="grid">
      <label>用户</label>
      <select name="user_id">
        <option value="">全部</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if filters and filters.user_id == u.id %}selected{% endif %}>{{ u.name }}（{{ u.username }}）</option>
        {% endfor %}
      </select>
      <label>动作</label>
      <input name="action" value="{{ filters.action if filters else '' }}" placeholder="例如：plan_submit / email_send / item_update" />
      <label>页码</label>
      <input name="page" type="number" value="{{ filters.page if filters else 1 }}" />
      <div></div>
      <button class="btn primary" type="submit">查询</button>
    </form>
  </div>

  <div class="card">
    <div class="actions">
      {% set q_user = filters.user_id if filters and filters.user_id else '' %}
      {% set q_action = filters.action if filters and filters.action else '' %}
      {% set page = pagination.page if pagination else 1 %}
      {% set has_next = pagination.has_next if pagination else false %}
      <div class="muted">第 {{ page }} 页（每页 50 条）</div>
      {% if page > 1 %}
        <a class="btn" href="/admin/logs?user_id={{ q_user }}&action={{ q_action }}&page={{ page - 1 }}">上一页</a>
      {% endif %}
      {% if has_next %}
        <a class="btn" href="/admin/logs?user_id={{ q_user }}&action={{ q_action }}&page={{ page + 1 }}">下一页</a>
      {% endif %}
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>时间</th>
          <th>用户</th>
          <th>动作</th>
          <th>对象</th>
          <th>路径</th>
          <th>IP</th>
          <th>详情</th>
        </tr>
      </thead>
      <tbody>
        {% for x in logs %}
          <tr>
            <td>{{ x.created_at.strftime("%Y-%m-%d %H:%M:%S") if x.created_at else "" }}</td>
            <td>{{ x.user.name if x.user else "-" }}</td>
            <td>{{ x.action }}</td>
            <td>{% if x.object_type %}{{ x.object_type }}{% endif %}{% if x.object_id %}#{{ x.object_id }}{% endif %}</td>
            <td>{{ x.method if x.method else "" }} {{ x.path if x.path else "" }}</td>
            <td>{{ x.ip if x.ip else "" }}</td>
            <td style="max-width:520px;white-space:pre-wrap;">{{ x.extra_json if x.extra_json else "" }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
