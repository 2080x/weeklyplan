{% extends "base.html" %}
{% block content %}
  <div class="row">
    <div class="col">
      <h1>我的周计划</h1>
      <div class="card">
        <div class="muted">默认进入本周登记：{{ current_period.year }} 年第 {{ current_period.week_no }} 周（{{ current_period.month }}月第{{ week_in_month_period(current_period.start_date) }}周）</div>
        <div class="actions">
          <a class="btn primary" href="/plans/{{ current_plan.id }}?embed=1" onclick="return openPlanDialog('/plans/{{ current_plan.id }}?embed=1')" data-open-plan-window>进入本周登记</a>
          <form method="get" action="/my" class="inline">
            <input class="date-input" name="d" type="date" value="{{ current_date_str }}" onchange="this.form.submit()" />
          </form>
        </div>
      </div>

      <div class="card">
        <h2>本月周计划</h2>
        <div class="actions">
          <a class="btn" href="/my?ym={{ prev_ym }}">上月</a>
          <a class="btn" href="/my?ym={{ this_ym }}">本月</a>
          <a class="btn" href="/my?ym={{ next_ym }}">下月</a>
          <form method="get" action="/my" class="inline" data-auto-submit>
            <input class="month-input" name="ym" type="month" value="{{ selected_ym }}" onchange="this.form.submit()" />
          </form>
          <button class="btn" type="button" data-refresh>刷新</button>
        </div>
        <div class="cards">
          {% set summaries = plan_summaries if plan_summaries is defined else {} %}
          {% for period in month_periods %}
            {% set plan = plans_by_period.get(period.id) %}
          {% set wd = period_workdays.get(period.id) %}
          <div class="week-card {% if period.id == current_period.id %}current{% endif %}">
              <h3>{{ period.year }}-W{{ period.week_no }}（{{ period.month }}月第{{ week_in_month_period(period.start_date) }}周）</h3>
              <div class="week-meta">
                <div class="muted">ISO周：{{ period.start_date }} ~ {{ period.end_date }}</div>
                {% if wd and wd["count"] > 0 %}
                  <div class="muted">工作日：{{ wd["start"] }} ~ {{ wd["end"] }}（{{ wd["count"] }} 天）</div>
                {% else %}
                  <div class="muted">工作日：-</div>
                {% endif %}
                {% set summary = (summaries.get(plan.id) if plan else none) %}
                {% set item_cnt = summary.get("items", 0) if summary else 0 %}
                <div class="muted">
                  状态：
                  {% if item_cnt > 0 %}
                    <span class="status-badge status-ok">已登记</span>
                  {% else %}
                    <span class="status-badge status-bad">未登记</span>
                  {% endif %}
                </div>
                <div class="muted">更新时间：{{ plan.updated_at.strftime("%Y-%m-%d %H:%M") if plan and plan.updated_at else "-" }}</div>
                {% if plan %}
                  <div class="muted">预计工时：{{ summary.get("estimated", "0.0") if summary else "0.0" }}h | 实际工时：{{ summary.get("actual", "0.0") if summary else "0.0" }}h | 事项：{{ item_cnt }}条</div>
                {% else %}
                  <div class="muted">预计工时：- | 实际工时：- | 事项：-</div>
                {% endif %}
              </div>
		            <div class="week-actions">
		              {% if plan and item_cnt > 0 %}
		                <a class="btn primary" href="/plans/{{ plan.id }}?embed=1" onclick="return openPlanDialog('/plans/{{ plan.id }}?embed=1')" data-open-plan-window>登记</a>
		                <button class="btn success" type="button" data-send-email="{{ plan.id }}">发送邮件</button>
		              {% elif plan %}
		                <a class="btn primary" href="/plans/{{ plan.id }}?embed=1" onclick="return openPlanDialog('/plans/{{ plan.id }}?embed=1')" data-open-plan-window>登记</a>
		              {% else %}
                <a class="btn primary" href="/my/open?period_id={{ period.id }}&embed=1" onclick="return openPlanDialog('/my/open?period_id={{ period.id }}&embed=1')" data-open-plan-window>登记</a>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <dialog id="planDialog" class="dialog dialog-large">
    <div class="dialog-inner">
      <div class="dialog-header">
        <div class="muted" id="planDialogTitle">周计划</div>
        <div class="dialog-actions">
          <button class="btn" type="button" data-plan-refresh>窗口内刷新</button>
          <button class="btn primary" type="button" data-plan-close>关闭</button>
        </div>
      </div>
      <iframe id="planDialogFrame" class="plan-frame" src="" frameborder="0"></iframe>
    </div>
  </dialog>
{% endblock %}
